<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de gastos</title>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  background: #f5f5f5;
}

header {
  background: white;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

button {
  padding: 10px 14px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
}

#addBtn {
  background: #4caf50;
  color: white;
  margin: 10px;
  width: calc(100% - 20px);
}

#grafica {
  background: white;
  margin: 10px;
  border-radius: 10px;
}

#formulario {
  display: none;
  background: white;
  margin: 10px;
  padding: 10px;
  border-radius: 10px;
}

select, input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  font-size: 16px;
}

.dia {
  background: white;
  margin: 10px;
  padding: 10px;
  border-radius: 10px;
}
</style>
</head>

<body>

<header>
  <button onclick="cambiarMes(-1)">◀</button>
  <strong id="tituloMes"></strong>
  <button onclick="cambiarMes(1)">▶</button>
</header>

<canvas id="grafica" height="220"></canvas>

<button id="addBtn" onclick="mostrarFormulario()">+ Añadir gasto</button>

<div id="formulario">
  <select id="categoria">
    <option value="ocio">Ocio</option>
    <option value="transporte">Transporte</option>
    <option value="comida">Comida</option>
    <option value="otros">Otros</option>
  </select>

  <input id="importe" type="number" placeholder="Importe €">
  <input id="comentario" type="text" placeholder="Comentario">

  <button onclick="guardarGasto()">Guardar</button>
</div>

<div id="listaGastos"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
let mesActual = new Date();
let grafica = null;

const coloresCategoria = {
  ocio: "rgba(255, 235, 59, 0.7)",
  transporte: "rgba(144, 202, 249, 0.7)",
  comida: "rgba(165, 214, 167, 0.7)",
  otros: "rgba(206, 147, 216, 0.7)"
};

function obtenerDatos() {
  return JSON.parse(localStorage.getItem("gastos")) || {};
}

function guardarDatos(datos) {
  localStorage.setItem("gastos", JSON.stringify(datos));
}

function mostrarFormulario() {
  document.getElementById("formulario").style.display = "block";
}

function guardarGasto() {
  const categoriaValor = document.getElementById("categoria").value;
  const importeValor = parseFloat(document.getElementById("importe").value);
  const comentarioValor = document.getElementById("comentario").value;

  if (!importeValor || importeValor <= 0) return;

  const fecha = new Date().toISOString().split("T")[0];
  const mes = fecha.slice(0, 7);

  const datos = obtenerDatos();
  if (!datos[mes]) datos[mes] = {};
  if (!datos[mes][fecha]) datos[mes][fecha] = [];

  datos[mes][fecha].push({
    categoria: categoriaValor,
    importe: importeValor,
    comentario: comentarioValor
  });

  guardarDatos(datos);

  document.getElementById("importe").value = "";
  document.getElementById("comentario").value = "";
  document.getElementById("formulario").style.display = "none";

  cargarMes();
}

function cargarMes() {
  const datos = obtenerDatos();
  const claveMes = mesActual.toISOString().slice(0, 7);

  const titulo = mesActual.toLocaleDateString("es-ES", {
    month: "long",
    year: "numeric"
  });
  document.getElementById("tituloMes").textContent =
    titulo.charAt(0).toUpperCase() + titulo.slice(1);

  const lista = document.getElementById("listaGastos");
  lista.innerHTML = "";

  const resumen = {
    ocio: 0,
    transporte: 0,
    comida: 0,
    otros: 0
  };

  if (datos[claveMes]) {
    Object.keys(datos[claveMes]).forEach(fecha => {
      const div = document.createElement("div");
      div.className = "dia";

      const fechaBonita = new Date(fecha).toLocaleDateString("es-ES", {
        weekday: "long",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });

      div.innerHTML = `<strong>${fechaBonita}</strong><br>`;

      datos[claveMes][fecha].forEach(g => {
        div.innerHTML += `${g.categoria}: ${g.importe.toFixed(2)} € (${g.comentario})<br>`;
        resumen[g.categoria] += g.importe;
      });

      lista.appendChild(div);
    });
  }

  dibujarGraficaMensual(resumen);
}

function dibujarGraficaMensual(resumen) {
  try {
    const canvas = document.getElementById("grafica");
    if (!canvas) return;

    if (grafica) grafica.destroy();

    grafica = new Chart(canvas, {
      type: "pie",
      data: {
        labels: Object.keys(resumen),
        datasets: [{
          data: Object.values(resumen),
          backgroundColor: Object.keys(resumen).map(
            c => coloresCategoria[c]
          )
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: "bottom"
          }
        }
      }
    });
  } catch (e) {
    console.error("Error en la gráfica:", e);
  }
}

function cambiarMes(d) {
  mesActual.setMonth(mesActual.getMonth() + d);
  cargarMes();
}

cargarMes();
</script>

</body>
</html>
